/*
  I REALLY love this problem, it's still BFS but with another parameter: level, the most important part of this problem is that I assume we won't go deeper than 100 level,
  if there is no such assumption, the BFS has no ends.

  我真的超愛這題，這一樣是 BFS 但要考慮多一個參數，還有一個很重要的點是我假設不會走超過 100 層，所以搜尋的範圍有限
  沒有限制的話 BFS 就跑不完了
*/

let map = `                               O         L       Z Z   P       X         P                                   
                               E         W       Z P   F       W         S                                   
  #############################.#########.#######.#.###.#######.#########.#################################  
  #...#.#.#.#.#.#...........#.#.......#.....#.#.#.....#.#.....#.#.....#.#...........#.....#.#.#.#.#.#...#.#  
  #.###.#.#.#.#.#####.#.###.#.#######.###.###.#.#.#.###.#.###.#.###.###.###.###########.###.#.#.#.#.#.###.#  
  #.#.....#...........#...#.....#...#.#.......#...#...#...#...#.#...#...........#...#.#...................#  
  #.###.#####.#.###.#.###.###.#####.#.#.#######.###########.#.#.#.#.#########.###.###.#.###.#.#.#.###.###.#  
  #.....#.....#.#.#.#...#.#...........#...#.#...#...#.#.....#.#...#...#...........#.#.#...#.#.#.#.#...#...#  
  #####.#######.#.#########.#.#.#.###.#.#.#.###.###.#.#.###.#.###.#.#.#.#.#.#####.#.#.#.#######.#.###.###.#  
  #...#.....#...#.#.#.......#.#.#...#.#.#.....#.....#...#...#.#.#.#.#.#.#.#.....#.#...#...#...#.#...#...#.#  
  #.###.#########.#.#.#####.#####.###.###.###.#.#######.#######.#####.#######.###.###.#.#####.###.#########  
  #...#.#...#.#.#.#.#.#.....#.......#...#.#...#.......#...#...............#...#.....#...........#.#...#.#.#  
  #.###.###.#.#.#.#.#####.#####.#.#.#######.#.###.#####.#######.#.###.###.###.#####.#.#.###########.###.#.#  
  #.........#.....#...#...#.....#.#.#...#.#.#.#...#...#.....#.#.#.#.#.#.#.#.....#.#...#.#.#.#.#...#.#.#.#.#  
  ###.#######.#######.#.###.#####.#####.#.###.#.#####.#.#####.#####.#.#.#.###.###.###.###.#.#.#.###.#.#.#.#  
  #.........#.#.#.#...#.#.#.#...........#.#.#.#...#.#.....#.#.......#...#.#.#.#...#.#.........#...#.#.#...#  
  #.#########.#.#.#.#####.#######.#.#.#.#.#.#.###.#.###.###.#.#.###.#.#####.#.#.###.###.#.#.###.#.#.#.#.###  
  #.....#.......#...#.........#...#.#.#.#.....#.....#.......#.#...#.#.#.........#.......#.#.#.#.#.#.#.....#  
  ###.#.###.#####.#######.###.#.###.#.#####.#####.#.###.#######.#####.#.###############.###.#.#.###.###.###  
  #.#.#.#...#.....#...#...#...#...#.#.#.#.#.#...#.#...#...#.#.....#.#.#.#.............#.#...#...#.....#...#  
  #.#.###.#####.#####.#######.#.#######.#.#.###.#####.#.###.#.#.###.#.#.#.#.#.#####.###########.#.#####.###  
  #.......#.#...#.#...#.#...........#.#.#.....#.......#...#.#.#.......#...#.#.#...#.#.#.#.#.........#.#...#  
  #.###.###.###.#.###.#.#########.###.#.#.#.###.###.###.###.#####.###.#####.###.#####.#.#.#####.###.#.#.#.#  
  #.#.....#.#...#.#.#...#.#.........#...#.#.#...#...#.......#.....#.#.#...........#.........#.#.#.#.#...#.#  
  #######.#.###.#.#.#.###.#######.###.#.###.###.###.###.###.#.#.###.###.#.###.#####.#########.#.#.###.#####  
  #...........#.#.#.....#.............#.#.#.#.....#.#...#.#.#.#.......#.#.#.....#.#.#...#.#...#.....#...#.#  
  #########.###.#.#.#######.#.#.#####.###.#.#####.#.#.###.#.###.#####.#.#####.###.#.###.#.#.#####.###.###.#  
  #.#.#.#.#.#...#.....#.#.#.#.#.#.........#...#...#.#.#.......#.#.....#...#...#...#.#...#.#.....#...#.....#  
  #.#.#.#.#.###.#.#.#.#.#.#######.#########.###.###########.#####.#####.#########.#.###.#.###.###.#####.#.#  
  #...#.#.....#...#.#.#...#.#    Y         H   N           T     S     W        #.#.#.....#.#.#...#.#.#.#.#  
  #.###.###.###.#.#####.###.#    T         V   P           Z     B     Z        #.#.###.#.#.#.###.#.#.#.###  
  #.#...#.#.....#...#.....#.#                                                   #.....#.#...........#...#.#  
  #.###.#.#.#.#########.#.#.#                                                   #.#.#####.#########.#.#.#.#  
TZ......#...#.....#...#.#...#                                                 PF..#.#...#.....#.......#....TF
  #.#.#####.#.#####.#.#####.#                                                   #.#.#.#.###.#.###.#.#####.#  
  #.#...#...#.....#.#.#.#...#                                                   #.#.#.#...#.#.#.#.#.#.....#  
  ###.#.#.###.#.#.###.#.###.#                                                   #.#.#.###.#.###.###########  
  #.#.#...#...#.#............XH                                                 #.#...#.....#.#.....#.....#  
  #.#####.#####.#.#.#.###.#.#                                                   ###.#########.###.#.#####.#  
  #...#.#.#.....#.#.#.#.#.#.#                                                   #...#.............#.#.....#  
  #.#.#.#.#########.###.#####                                                   ###.#.###.#.#####.#####.#.#  
NJ..#.#.#.#...#.#.#.....#...#                                                   #.#.#...#.#.#...........#..NP
  ###.#.###.#.#.#.#.#######.#                                                   #.#####.#####.###.###.#.###  
  #.....#.#.#.#...#.#.......#                                                   #.......#...#.#.....#.#...#  
  #####.#.#.#####.###.#.###.#                                                   #.#########.###############  
  #...#...............#.#.#..KX                                               PS....#.....#.#.#.#...#...#.#  
  #.#####################.###                                                   #########.#.#.#.#.#####.#.#  
  #.................#.......#                                                   #..........................YT
  #.###.#.#.###.###.#.###.###                                                   #.###.###.#.#.#.#.###.###.#  
KX....#.#.#.#...#.....#.....#                                                 IF....#.#...#.#.#.#...#.#...#  
  #.###.###.#####.#.###.#####                                                   #########.#################  
  #.#...#...#.#...#.#........XW                                                 #...#...#.#.#.#.#..........HV
  #.###.###.#.#####.#.#######                                                   #.#####.###.#.#.#.#####.#.#  
  #.#.#.#.#.#.#...#.#.#.#...#                                                 XG..#.#.#...#...#...#...#.#.#  
  ###.###.###.###.#####.#.#.#                                                   #.#.#.#.###.#.#.#.#.#####.#  
  #.#.#.#.#.#.#.#.........#.#                                                   #...#.......#.#.#.#...#.#.#  
  #.#.#.#.#.#.#.#######.###.#                                                   #.#####.#.#.#####.###.#.###  
SO....#.........#.#.....#...#                                                   #.......#.#.......#...#.#.#  
  #.###.###.#.#.#.###.###.###                                                   #####.#.#####.#######.#.#.#  
  #.....#...#.#.......#.#....XX                                               MU..#...#.....#.#...........#  
  #.#.###.#####.#####.#.#.###                                                   #.#####.#######.#######.###  
  #.#.#.#.#.#.....#.....#.#..YH                                                 #.#.#...#.#...........#...#  
  #####.###.###############.#                                                   #.#.#####.#.###.#.#.###.#.#  
  #...#...#...#.#.#...#...#.#                                                   #.#...#.#.#...#.#.#...#.#..TH
  #.#####.#.###.#.#.###.###.#                                                   #.#.###.#.#######.#########  
XH..#.#.#.....#.#...#...#.#.#                                                   #...................#.#...#  
  #.#.#.#.#.###.###.#.#.#.#.#                                                   #####################.###.#  
  #.......#...........#.....#                                                   #.....#.........#..........VD
  #########.###.###.#.#.#.###                                                   #.###.#.#.#.###.#.#.#####.#  
IF......#.#.#.#.#...#.#.#.#.#                                                 OE..#...#.#.#.#.....#...#...#  
  #.#####.#.#.#######.#.###.#                                                   #.#.###.###.###.###.#.#.###  
  #...#.#.#...#.#.#...#.#.#..LW                                                 #.#...#...#.#.....#.#.#.#..AA
  #.#.#.#.#####.#.#######.#.#                                                   #####.#.#.#####.#.###.#.#.#  
YH..#.#...#.......#...#...#..NJ                                                 #.......#.#...#.#.#...#...#  
  #.###.#.###.#.#.#.###.#.#.#                                                   #####.#####.#.#######.#####  
  #.....#.....#.#.......#...#                                                   #.#.....#.#.#.#.#...#.#...#  
  ###########################                                                   #.###.###.#.###.#.#####.#.#  
  #...............#.#.......#                                                   #.#.#.#.#.....#...#.....#..KI
  ###.#####.#.###.#.#.#.#.#.#                                                   #.#.###.#.#######.#####.#.#  
  #.....#.#.#.#.....#.#.#.#..SO                                               TF..#...#...#.#.......#...#.#  
  #.#####.###.###.#.###.#.#.#                                                   #.#.#.#.#.#.###.#.###.###.#  
WZ..........#.#.#.#.#.#.#.#.#                                                   #...#...#.......#.......#.#  
  #.###.#.#.###.###.#.#.###.#                                                   #.#.###.#.#.###.#.###.#####  
  #...#.#.#.#.............#.#                                                   #.#...#.#.#...#.#...#.....#  
  #.###.#####.#####.#.#.###.#      Q           T       K   V         Z     T    ###.#.#.#####.#.###.#.#.###  
  #.#.....#.#...#...#.#...#.#      B           H       I   D         P     G    #...#.#...#...#...#.#.#...#  
  #########.#.###.###.#####.#######.###########.#######.###.#########.#####.###########.###.#.#.#.#####.###  
  #...#.......#.#...#.#.#.#.#.#.........#.#.#...#...#...#...#.#.#.....#.....#...#...#.#.#...#.#.#...#.....#  
  ###.#.#.#####.#.#####.#.###.###.###.###.#.#.###.#.###.#.###.#.#.#######.#.#.###.###.#.#####.###.#.#.#.###  
  #.....#.#.......#...#.#.........#.....#.#.#.#...#...#.#.....#.........#.#...#...#...#.....#.#...#.#.#...#  
  #.#.#.###.#####.#.###.#.###.#.#####.#.#.#.#.###.###.#.#.#.#.#.#.#.#########.#.###.#.#########.#.#.###.###  
  #.#.#.#...#.#.........#.#...#.#.#...#.#.....#...#.#...#.#.#.#.#.#...#...#.#.......#.....#...#.#.#...#...#  
  #.#####.###.#.#####.#######.###.#.###.#.#######.###.###.#####.###.###.###.#.#.###.###.#.#.#.###.#.###.###  
  #.#...#.#.......#.........#.#.....#.#.#.......#.#.#.#.....#.#.#.......#.....#...#.#.#.#...#.#...#...#...#  
  #.###.#.#.###.###.#.#######.#######.#.#######.#.#.#.###.#.#.#.#####.###.#.###.###.#.###.###.#####.#.#.#.#  
  #.#.....#...#...#.#.#...#.#.#.#.........#.#...#...#.#...#...#.#.......#.#...#...#.....#...#.#.#.#.#.#.#.#  
  ###.#.#.#.#.###.###.###.#.###.#######.###.#.#.#.#.#####.#.#########.#.###.#########.###.###.#.#.#.#######  
  #...#.#.#.#.#...#...#.......#...#.#.....#...#.#.#.....#.#.#.....#...#.#...#.....#.#.#.....#.#...........#  
  ###.###.#####.#####.#####.###.###.###.#######.#.#.#######.###.#.###.#####.#.#####.#####.#.###.#.#####.#.#  
  #.....#.#...#.#.....#.....#.#.#...#.#.#...#...#.#.#.#...#...#.#.....#...#...........#...#.#.#.#.#.....#.#  
  #.###.#####.#.#####.#####.#.#.###.#.#.#.#####.#.###.###.###.#####.#.###.#.#.###.###########.###.#####.#.#  
  #.#.#.#.......#...#.#...............#...#.#...#...#.........#.....#.#.....#.#.#.#.........#.#.......#.#.#  
  ###.#######.#####.#######.#.###.###.#.#.#.###.#.#.#######.#.#.#.#.###.###.###.###.#########.###.#########  
  #.#...#...#.#.#.#...#.....#.#...#.#.#.#.#.....#.#.#.#.#...#.#.#.#.#.....#.......#.....#.#.....#...#...#.#  
  #.#.#####.###.#.#.#.#.#.#######.#.#.#.#####.###.###.#.#####.#.#######.#######.###.#.###.#.#########.###.#  
  #.....#...#.....#.#.#.#.#.......#.#...#.#...#.#...#.#...#.#.#...#.#.........#.#...#.#.............#.#...#  
  #.###.#.#.###.#####.#.#########.#.#####.#.###.#.###.#.###.#.###.#.#####.#.#####.#####.#.#.#.#.###.#.###.#  
  #.#.#.#.#.............#.................#.#...#.#.....#.......#.....#...#.#.....#.....#.#.#.#.#.#.......#  
  ###.#.#####.###.#.#####.#.###.#.#.###.#.#.#.#.#.###.#####.#####.#.#.###.###.#######.###########.#.#####.#  
  #.............#.#.#.#...#.#...#.#.#...#.#.#.#.#...#...#.......#.#.#.#...#.....................#.#.....#.#  
  #####.#.###.#.#.###.###.###.#.###.#.#####.#.#.#.###.#######.#######.#.###.#.#.#.#.#.###.#.#####.###.###.#  
  #.....#...#.#.#.#.......#...#.#...#.#.......#.#.........#...#.......#.....#.#.#.#.#...#.#.......#.....#.#  
  ###################################.#########.#####.#####.#####.###########.#############################  
                                     X         S     T     Q     M           X                               
                                     G         B     G     B     U           X                               `


map = map.split('\n')
let newMap = []
let transports = {

}
let startX = 0
let startY = 0
let endX = 0
let endY = 0
for(let y=0; y<map.length; y++) {
  newMap[y] = []
  for(let x=0; x<map[y].length; x++) {
    if (map[y][x] !== '.') {
      newMap[y][x] = '#'
      continue
    } 

    let name = null
    if (y-2 >= 0 && isAlphabet(map[y-1][x]) && isAlphabet(map[y-2][x])) {
      name = map[y-2][x] + map[y-1][x]
    } else if (y+2 < map.length && isAlphabet(map[y+1][x]) && isAlphabet(map[y+2][x])) {
      name = map[y+1][x] + map[y+2][x]
    } else if (x-2 >= 0 && isAlphabet(map[y][x-2]) && isAlphabet(map[y][x-1])) {
      name = map[y][x-2] + map[y][x-1]
    } else if (x+2 < map[y].length && isAlphabet(map[y][x+1]) && isAlphabet(map[y][x+2])) {
      name = map[y][x+1] + map[y][x+2]
    }

    if (!name) {
      newMap[y][x] = '.'
      continue
    }

    if (name === 'AA') {
      startY = y
      startX = x
      newMap[y][x] = '.'
      continue
    }

    if (name === 'ZZ') {
      endY = y
      endX = x
      newMap[y][x] = '.'
      continue
    }

    if (!transports[name]) {
      transports[name] = []
    }
    transports[name].push({x, y})
    newMap[y][x] = '.'
  }
}

var teleports = {}
for(let key in transports) {
  let arr = transports[key]
  teleports[arr[0].x + ',' + arr[0].y] = arr[1]
  teleports[arr[1].x + ',' + arr[1].y] = arr[0]
}

// BFS
let queue = [
  {x: startX, y: startY, level: 0}
]
let ans = []
for(let y=0; y<newMap.length; y++) {
  ans[y] = []
  for(let x=0; x<newMap[y].length; x++) {
    ans[y][x] = []
  }
}

ans[startY][startX][0] = 0

let dir = [
  {dx: 1, dy: 0},
  {dx: -1, dy: 0},
  {dx: 0, dy: 1},
  {dx: 0, dy: -1}
]

while(queue.length) {
  let {x, y, level} = queue.shift()

  for(let d of dir) {
    let newX = x + d.dx
    let newY = y + d.dy
    if (
      newX < 0 ||
      newY < 0 ||
      newX >= newMap[0].length ||
      newY >= newMap.length ||
      newMap[newY][newX] !== '.' ||
      (ans[y][x][level] + 1 >= ans[newY][newX][level] && ans[newY][newX][level] !== undefined)
    ) {
      continue
    }

    ans[newY][newX][level] = ans[y][x][level] + 1
    queue.push({x: newX, y: newY, level: level})
  }

  let tp = teleports[x + ',' + y]
  
  // If dl is -1, it means this will lead you to the -1 level
  let dl = (y === 2 || y === newMap.length - 3 || x === 2 || x === newMap[0].length - 3) ? -1 : 1
  if (!tp) {
    continue
  }

  // we can't go up if it's level0
  if (dl === -1 && level === 0) continue
  let newLevel = level + dl
  if (ans[y][x][level] + 1 >= ans[tp.y][tp.x][newLevel] && ans[tp.y][tp.x][newLevel] !== undefined) {
    continue
  }
  // We don't walk further than 100 level (it's important, otherwise we won't end the loop)
  // 我們不走超過 100 層，這超重要，沒加這個條件會走不完
  if (level >=100 && dl === 1) {
    continue
  }

  ans[tp.y][tp.x][newLevel] = ans[y][x][level] + 1
  queue.push({x: tp.x, y: tp.y, level: newLevel})
}

console.log(ans[endY][endX][0])

function isAlphabet(c) {
  return c>='A' && c<='Z'
}
